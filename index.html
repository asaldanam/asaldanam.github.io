<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <style>
    pre {
      font-size: 11px;
      margin: 0;
    }
  </style>
</head>

<body>
  <code id="container"></code>
  <script>
    const log = (...args) => {
      console.log(...args);
      args.forEach(arg => {
        document.querySelector('#container').innerHTML += `<pre>${JSON.stringify(arg, null, 2)}</pre>`;
      });
    }
  </script>
  <script type="module">
    import webrtcAdapter from 'https://cdn.jsdelivr.net/npm/webrtc-adapter@9.0.1/+esm'
    log('webrtcAdapter browser', webrtcAdapter.browserDetails.browser)
    log('webrtcAdapter version', webrtcAdapter.browserDetails.version)

    const isSafariIos = navigator.userAgent.includes('Safari') && navigator.userAgent.includes('Mobile');
    log({ isSafariIos });

    if (isSafariIos) {
      const media = await navigator.mediaDevices?.getUserMedia?.({ audio: true, video: true });
      log({ media: !!media });
    }

    const config = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { urls: 'stun:stun.services.mozilla.com' },
        { urls: 'stun:stun.stunprotocol.org:3478' },
        { urls: 'stun:stun.voipbuster.com' },
        { urls: 'stun:stun.voxgratia.org' },
        { urls: 'stun:stun.xten.com' },
        { urls: 'stun:stun.schlund.de' },
        { urls: 'stun:stun.iptel.org' },
        { urls: 'stun:stun.ideasip.com' },
        { urls: 'stun:stun.ekiga.net' },
        { urls: 'stun:stun.12connect.com' },
        { urls: 'stun:stun.12voip.com' },
        { urls: 'stun:stun.1und1.de' },
        { urls: 'stun:stun.2talk.co.nz' },
        { urls: 'stun:stun.3clogic.com' },
        { urls: 'stun:stun.3cx.com' },
        { urls: 'stun:stun.3gppnetwork.org' },
        { urls: 'stun:stun.3starsnet.com' },
        { urls: 'stun:stun.4g.de' },
        { urls: 'stun:stun.4psa.com' },
        { urls: 'stun:stun.5centscdn.net' },
        { urls: 'stun:stun.5elementscloud.com' },
        { urls: 'stun:stun.5x5pbx.com' },
        { urls: 'stun:stun.7rtc.com' },
        { urls: 'stun:stun.8050.com' },
      ]
    };

    const peer1 = new RTCPeerConnection(config)

    peer1.addEventListener('signalingstatechange', _ => log('1 signaling state ' + peer1.signalingState));
    peer1.addEventListener('icegatheringstatechange', _ => log('1 ICE gathering state ' + peer1.iceGatheringState));
    peer1.addEventListener('connectionstatechange', _ => log('1 connection state ' + peer1.connectionState, peer1));

    const peer2 = new RTCPeerConnection(config);
    peer2.addEventListener('signalingstatechange', _ => log('2 signaling state ' + peer2.signalingState));
    peer2.addEventListener('icegatheringstatechange', _ => log('2 ICE gathering state ' + peer2.iceGatheringState));
    peer2.addEventListener('connectionstatechange', _ => log('2 connection state ' + peer2.connectionState, peer2));

    const dataChannel = peer1.createDataChannel(null);

    const offer = await peer1.createOffer({ iceRestart: true, offerToReceiveAudio: true, offerToReceiveVideo: true });
    await peer1.setLocalDescription(offer);
    await peer2.setRemoteDescription(offer);

    const answer = await peer2.createAnswer({ iceRestart: true, offerToReceiveAudio: true, offerToReceiveVideo: true });
    await peer2.setLocalDescription(answer);
    await peer1.setRemoteDescription(answer);

    peer1.addEventListener('icecandidate', event => {
      log('1 ICE candidate ' + (event.candidate ? event.candidate.candidate : 'null'))
      if (event.candidate !== null) {
        peer2.addIceCandidate(event.candidate);
      }
    });

    peer2.addEventListener('icecandidate', event => {
      log('2 ICE candidate ' + (event.candidate ? event.candidate.candidate : 'null'))
      if (event.candidate !== null) {
        peer1.addIceCandidate(event.candidate);
      }
    });

    dataChannel.addEventListener('open', () => {
      dataChannel.send('message from 1 to 2');
    });

    dataChannel.addEventListener('message', event => {
      log('2: ' + event.data);
    });

    peer2.addEventListener('datachannel', event => {
      log(event.channel, 'dc 2');
      event.channel.addEventListener('open', () => {
        event.channel.send('message from 2 to 1');
      });

      event.channel.addEventListener('message', event => {
        log('1: ' + event.data);
      });
    });
  </script>
</body>

</html>